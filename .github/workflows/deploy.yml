name: Deploy Server Optimization Tools

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    runs-on: ubuntu-latest
    name: Validate Scripts
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Validate shell scripts
      run: |
        echo "ğŸ” Validating shell scripts..."
        find . -name "*.sh" -type f | while read -r script; do
          echo "Checking: $script"
          if ! bash -n "$script"; then
            echo "âŒ Syntax error in: $script"
            exit 1
          fi
        done
        echo "âœ… All scripts are valid"
        
    - name: Check script permissions
      run: |
        echo "ğŸ”§ Checking script permissions..."
        find . -name "*.sh" -type f | while read -r script; do
          if [[ ! -x "$script" ]]; then
            echo "âš ï¸ Script not executable: $script"
            chmod +x "$script"
            echo "âœ… Fixed permissions for: $script"
          fi
        done
        
    - name: Test installation scripts
      run: |
        echo "ğŸ§ª Testing installation scripts..."
        # æµ‹è¯•bootstrap.shè¯­æ³•
        bash -n bootstrap.sh
        # æµ‹è¯•install-online.shè¯­æ³•
        bash -n install-online.sh
        echo "âœ… Installation scripts are valid"

  update-urls:
    runs-on: ubuntu-latest
    name: Update Download URLs
    needs: validate
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Update repository URLs
      run: |
        echo "ğŸ”„ Updating repository URLs..."
        
        # è·å–ä»“åº“ä¿¡æ¯
        REPO_OWNER="${{ github.repository_owner }}"
        REPO_NAME="${{ github.event.repository.name }}"
        
        echo "Repository: $REPO_OWNER/$REPO_NAME"
        
        # æ›´æ–°bootstrap.shä¸­çš„URL
        sed -i "s|your-username|$REPO_OWNER|g" bootstrap.sh
        sed -i "s|server-scripts|$REPO_NAME|g" bootstrap.sh
        
        # æ›´æ–°install-online.shä¸­çš„URL
        sed -i "s|your-username|$REPO_OWNER|g" install-online.sh
        sed -i "s|server-scripts|$REPO_NAME|g" install-online.sh
        
        # æ›´æ–°æ–‡æ¡£ä¸­çš„ç¤ºä¾‹URL (DEPLOY.mdå·²åˆ é™¤ï¼Œä¿ç•™å…¶ä»–æ–‡æ¡£æ›´æ–°)
        # sed -i "s|your-username|$REPO_OWNER|g" DEPLOY.md
        # sed -i "s|server-scripts|$REPO_NAME|g" DEPLOY.md
        
        echo "âœ… URLs updated successfully"
        
    - name: Commit updated URLs
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if git diff --quiet; then
          echo "No changes to commit"
        else
          git add bootstrap.sh install-online.sh
          git commit -m "ğŸ¤– Auto-update repository URLs"
          git push
        fi

  create-release:
    runs-on: ubuntu-latest
    name: Create Release
    needs: [validate, update-urls]
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Get version from tag
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"
        
    - name: Update version.txt
      run: |
        echo "${{ steps.version.outputs.version }}" > version.txt
        
    - name: Create changelog
      id: changelog
      run: |
        echo "## ğŸš€ ç‰ˆæœ¬ ${{ steps.version.outputs.version }}" > CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "### æ–°å¢åŠŸèƒ½" >> CHANGELOG.md
        echo "- å®Œæ•´çš„æœåŠ¡å™¨ä¼˜åŒ–å·¥å…·é›†åˆ" >> CHANGELOG.md
        echo "- ä¸€é”®åœ¨çº¿å®‰è£…åŠŸèƒ½" >> CHANGELOG.md
        echo "- IPv6ç¦ç”¨ã€TCPä¼˜åŒ–ã€BBRå¯ç”¨" >> CHANGELOG.md
        echo "- SSHå®‰å…¨é…ç½®ã€DNSæœåŠ¡å™¨é…ç½®" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "### å®‰è£…æ–¹å¼" >> CHANGELOG.md
        echo '```bash' >> CHANGELOG.md
        echo "# ç®€åŒ–å®‰è£…" >> CHANGELOG.md
        echo "bash <(curl -sL https://raw.githubusercontent.com/${{ github.repository }}/main/install-online.sh)" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "# å®Œæ•´å®‰è£…" >> CHANGELOG.md
        echo "bash <(curl -sL https://raw.githubusercontent.com/${{ github.repository }}/main/bootstrap.sh)" >> CHANGELOG.md
        echo '```' >> CHANGELOG.md
        
    - name: Create GitHub Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Server Optimization Tools v${{ steps.version.outputs.version }}
        body_path: CHANGELOG.md
        draft: false
        prerelease: false

  deploy-pages:
    runs-on: ubuntu-latest
    name: Deploy to GitHub Pages
    needs: validate
    if: github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
      pages: write
      id-token: write
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Prepare Pages content
      run: |
        mkdir -p public
        
        # å¤åˆ¶æ··åˆä¸»é¡µæ–‡ä»¶ï¼ˆåŒæ—¶æ”¯æŒHTMLå’Œbashè„šæœ¬ï¼‰
        cp index.html public/index.html
        
        # å¤åˆ¶å®‰è£…è„šæœ¬åˆ°publicç›®å½•ï¼Œæ”¯æŒè‡ªå®šä¹‰åŸŸåè®¿é—®
        cp install-online.sh public/install-online.sh
        cp install-online.sh public/install          # åˆ«åï¼Œæ”¯æŒ ss.hide.ss/install
        cp bootstrap.sh public/bootstrap.sh
        cp bootstrap.sh public/bootstrap             # åˆ«åï¼Œæ”¯æŒ ss.hide.ss/bootstrap  
        cp version.txt public/version.txt
        cp version.txt public/version                # åˆ«åï¼Œæ”¯æŒ ss.hide.ss/version
        
        # å¤åˆ¶CNAMEæ–‡ä»¶ä»¥æ”¯æŒè‡ªå®šä¹‰åŸŸå
        cp CNAME public/CNAME
        
        # éªŒè¯æ··åˆä¸»é¡µæ–‡ä»¶
        if [[ -f public/index.html ]]; then
            echo "âœ… æ··åˆä¸»é¡µæ–‡ä»¶ï¼ˆHTML+Bashï¼‰å·²å‡†å¤‡å®Œæˆ"
            # éªŒè¯æ–‡ä»¶åŒ…å«å¿…è¦çš„bashè„šæœ¬å†…å®¹
            if head -1 public/index.html | grep -q "#!/bin/bash"; then
                echo "âœ… è„šæœ¬åŠŸèƒ½éªŒè¯é€šè¿‡"
            else
                echo "âŒ ä¸»é¡µæ–‡ä»¶ç¼ºå°‘bashè„šæœ¬åŠŸèƒ½"
            fi
        else
            echo "âŒ ä¸»é¡µæ–‡ä»¶ç¼ºå¤±"
            exit 1
        fi
        
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./public
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4