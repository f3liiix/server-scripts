#!/bin/bash

# ==============================================================================
# Script Name: install_bt.sh
# Description: Install Baota Panel happy version
# Author:      f3liiix
# Date:        2025-08-07
# Version:     1.0.0
# ==============================================================================

# è·å–è„šæœ¬ç›®å½•
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# åŠ è½½é€šç”¨å‡½æ•°åº“
if [[ -f "$SCRIPT_DIR/common_functions.sh" ]]; then
    # shellcheck source=./common_functions.sh
    source "$SCRIPT_DIR/common_functions.sh"
else
    echo "é”™è¯¯: æ— æ³•æ‰¾åˆ°é€šç”¨å‡½æ•°åº“ common_functions.sh"
    exit 1
fi

# æ£€æŸ¥rootæƒé™
check_root || exit 1

# å®å¡”é¢æ¿å®‰è£…é€‰é¡¹èœå•
show_bt_menu() {
    echo
    echo -e "${CYAN}ğŸ”¸ è¯·é€‰æ‹©æ“ä½œ${NC}"
    echo -e "${DARK_GRAY}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo -e "  ${CYAN}1${NC} â–¶ ğŸ“¦ å®‰è£…å®å¡”é¢æ¿ 11.0.0 å¼€å¿ƒç‰ˆ${GRAY}ï¼ˆæ”¯æŒ Debian/Ubuntu/CentOS ç­‰ç³»ç»Ÿï¼‰${NC}"
    echo -e "  ${CYAN}2${NC} â–¶ ğŸ”„ å‡çº§å®å¡”é¢æ¿è‡³ 11.0.0 å¼€å¿ƒç‰ˆ${GRAY}ï¼ˆæ”¯æŒæ‰€æœ‰ç‰ˆæœ¬å‡çº§è‡³å¼€å¿ƒç‰ˆï¼‰${NC}"
    echo -e "  ${DARK_GRAY}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo -e "  ${CYAN}0${NC} â–¶ ğŸšª é€€å‡º"
    echo
}

# å®‰è£…å®å¡”é¢æ¿ 11.0.0 å¼€å¿ƒç‰ˆ
install_bt() {
    log_step "æ­£åœ¨å®‰è£…å®å¡”é¢æ¿ 11.0.0 å¼€å¿ƒç‰ˆ..."
    
    echo -e "${DARK_GRAY}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    
    # æ£€æŸ¥ç³»ç»Ÿæ”¯æŒ
    local system_info
    system_info=$(detect_system)
    local distro="${system_info%:*}"
    
    case "$distro" in
        "centos"|"debian"|"ubuntu"|"fedora")
            log_info "æ£€æµ‹åˆ°æ”¯æŒçš„ç³»ç»Ÿ: $distro"
            ;;
        *)
            log_warning "ç³»ç»Ÿ $distro å¯èƒ½ä¸å—æ”¯æŒï¼Œç»§ç»­å®‰è£…..."
            ;;
    esac
    
    # æ‰§è¡Œå®‰è£…å‘½ä»¤
    if [ -f /usr/bin/curl ]; then
        curl -sSO https://io.bt.sb/install/install_latest.sh
    else
        wget -O install_latest.sh https://io.bt.sb/install/install_latest.sh
    fi
    
    if [[ -f "install_latest.sh" ]]; then
        bash install_latest.sh
        rm -rf install_latest.sh
        log_success "å®å¡”é¢æ¿å®‰è£…å®Œæˆ"
    else
        log_error "ä¸‹è½½å®‰è£…è„šæœ¬å¤±è´¥"
        return 1
    fi
    
    echo -e "${DARK_GRAY}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
}

# å‡çº§å®å¡”é¢æ¿è‡³ 11.0.0 å¼€å¿ƒç‰ˆ
update_bt() {
    log_step "æ­£åœ¨å‡çº§å®å¡”é¢æ¿è‡³ 11.0.0 å¼€å¿ƒç‰ˆ..."
    
    echo -e "${DARK_GRAY}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    
    # æ‰§è¡Œå‡çº§å‘½ä»¤
    if command_exists curl; then
        curl https://io.bt.sb/install/update_panel.sh | bash -s -- 11.0.0
        log_success "å®å¡”é¢æ¿å‡çº§å®Œæˆ"
    else
        log_error "ç³»ç»Ÿç¼ºå°‘ curl å‘½ä»¤ï¼Œè¯·å…ˆå®‰è£… curl"
        return 1
    fi
    
    echo -e "${DARK_GRAY}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
}

# ä¸»ç¨‹åº
main() {
    while true; do
        show_bt_menu
        read -p "$(echo -e "${YELLOW}è¯·è¾“å…¥é€‰æ‹© (1-2, 0): ${NC}")" choice
        
        case $choice in
            1)
                echo
                echo -e "${CYAN}â–¶â–¶â–¶ æ­£åœ¨æ‰§è¡Œ [å®‰è£…å®å¡”é¢æ¿ 11.0.0 å¼€å¿ƒç‰ˆ]${NC}"
                install_bt
                echo
                echo -e "${CYAN}æŒ‰ä»»æ„é”®è¿”å›å®å¡”é¢æ¿èœå•...${NC}"
                read -n 1 -s
                echo
                ;;
            2)
                echo
                echo -e "${CYAN}â–¶â–¶â–¶ æ­£åœ¨æ‰§è¡Œ [å‡çº§å®å¡”é¢æ¿è‡³ 11.0.0 å¼€å¿ƒç‰ˆ]${NC}"
                if ! update_bt; then
                    log_error "å‡çº§è¿‡ç¨‹å‡ºç°é”™è¯¯"
                fi
                echo
                echo -e "${CYAN}æŒ‰ä»»æ„é”®è¿”å›å®å¡”é¢æ¿èœå•...${NC}"
                read -n 1 -s
                echo
                ;;
            0)
                return 0
                ;;
            *)
                echo
                log_warning "æ— æ•ˆé€‰æ‹©ï¼Œè¯·è¾“å…¥ 0-2 ä¹‹é—´çš„æ•°å­—"
                echo
                sleep 2
                ;;
        esac
    done
}

# æ‰§è¡Œä¸»ç¨‹åº
main "$@"